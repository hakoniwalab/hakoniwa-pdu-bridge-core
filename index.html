<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Hakoniwa Bridge Visualizer - Fixed Edition</title>

  <link rel="stylesheet" href="https://unpkg.com/reactflow@11.11.4/dist/style.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; overflow: hidden; background: #f1f5f9; }
    .app { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #1e293b; color: white; padding: 0.75rem 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1); z-index: 50; display: flex; justify-content: space-between; align-items: center; }
    .main { flex: 1; display: flex; overflow: hidden; }
    
    /* Sidebar */
    .sidebar { width: 450px; border-right: 1px solid #e2e8f0; background: #fff; padding: 1.25rem; overflow-y: auto; z-index: 40; display: flex; flex-direction: column; }
    .canvas { flex: 1; position: relative; background: #f8fafc; }

    .btn { cursor: pointer; border: none; padding: .6rem .8rem; border-radius: .4rem; font-weight: 600; font-size: 13px; transition: opacity 0.2s; }
    .btn.primary { background: #2563eb; color: #fff; }
    .btn.secondary { background: #64748b; color: #fff; }
    .btn.outline { background: transparent; border: 1px solid #cbd5e1; color: #334155; }
    .btn:hover { opacity: 0.9; }

    textarea {
      width: 100%; flex: 1; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 11px; padding: .75rem; border: 1px solid #e2e8f0; border-radius: .35rem; resize: none; margin-bottom: 1rem;
      background: #fdfdfd; line-height: 1.5;
    }

    .error-box { margin-bottom: 1rem; padding: .75rem; background: #fef2f2; border: 1px solid #fca5a5; border-radius: .35rem; color: #b91c1c; font-size: 12px; white-space: pre-wrap; }
    .status-ok { color: #16a34a; font-size: 12px; font-weight: bold; }

    /* --- Custom Node Styles --- */
    .bridge-node { background: #fff; border: 2px solid #334155; border-radius: 8px; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .node-header { background: #334155; color: white; padding: 8px 12px; border-radius: 5px 5px 0 0; font-weight: 800; font-size: 13px; display: flex; justify-content: space-between; }
    .node-body { padding: 12px; }
    
    .section-title { font-size: 10px; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin: 12px 0 6px 0; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; }

    /* Endpoints with Handles */
    .ep-item { position: relative; display: flex; align-items: center; margin-bottom: 6px; }
    .pill {
      display: flex; align-items: center; gap: 8px; width: 100%; padding: 4px 12px; border-radius: 6px;
      font-size: 11px; font-weight: 700; border: 1px solid; justify-content: space-between;
    }
    .pill.local { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }
    .pill.wire  { background: #faf5ff; border-color: #e9d5ff; color: #7e22ce; }

    /* ReactFlow Handles */
    .react-flow__handle { width: 10px; height: 10px; border: 2px solid #fff; }
    .react-flow__handle-left { left: -16px; }
    .react-flow__handle-right { right: -16px; }

    /* Connection Card */
    .conn-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; margin-top: 6px; }
    .conn-path { font-family: monospace; font-size: 11px; font-weight: bold; color: #1e293b; margin-bottom: 4px; }
    .pdu-tag { font-family: monospace; font-size: 10px; color: #64748b; background: #fff; border: 1px solid #e2e8f0; padding: 1px 4px; border-radius: 3px; display: inline-block; margin-right: 4px; }

    input[type="file"] { display: none; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/reactflow@11.11.4/dist/umd/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv7.min.js"></script>

  <script>
    window.addEventListener("load", () => {
      const { useState, useEffect, useCallback } = React;
      const { ReactFlow, Background, Controls, MiniMap, Panel, useNodesState, useEdgesState, MarkerType, Handle, Position } = window.ReactFlow;

      // ---- JSON Schema ----
      const BRIDGE_SCHEMA = {
        type: "object",
        required: ["nodes", "endpoints"],
        properties: {
          nodes: { type: "array" },
          endpoints: { type: "array" },
          wireLinks: { type: "array" },
          connections: { type: "array" }
        }
      };

      const SAMPLE_DATA = {
        "version": "2.0.0",
        "nodes": [{ "id": "DroneNode" }, { "id": "GCSNode" }],
        "endpoints": [
          { "nodeId": "DroneNode", "endpoints": [{ "id": "D_LOCAL", "mode": "local" }, { "id": "D_WIRE", "mode": "wire" }] },
          { "nodeId": "GCSNode", "endpoints": [{ "id": "G_WIRE", "mode": "wire" }, { "id": "G_LOCAL", "mode": "local" }] }
        ],
        "wireLinks": [{ "from": "D_WIRE", "to": "G_WIRE" }],
        "connections": [
          { "id": "c1", "nodeId": "DroneNode", "source": { "endpointId": "D_LOCAL" }, "destinations": [{ "endpointId": "D_WIRE" }], "transferPdus": [{ "pduKeyGroupId": "telemetry", "policyId": "fast" }] }
        ]
      };

      // ---- Node Component ----
      function BridgeNode({ data }) {
        return React.createElement("div", { className: "bridge-node" },
          React.createElement("div", { className: "node-header" }, 
            React.createElement("span", null, "ID: " + data.label),
            React.createElement("span", { style: {opacity: 0.5} }, "#node")
          ),
          React.createElement("div", { className: "node-body" },
            
            React.createElement("div", { className: "section-title" }, "Endpoints"),
            (data.endpoints || []).map(ep => 
              React.createElement("div", { key: ep.id, className: "ep-item" },
                React.createElement(Handle, { type: "target", position: Position.Left, id: ep.id, style: { background: ep.mode === "wire" ? "#a855f7" : "#3b82f6" } }),
                React.createElement("div", { className: "pill " + (ep.mode === "wire" ? "wire" : "local") },
                  React.createElement("span", null, ep.id),
                  React.createElement("span", { style: { fontSize: '8px', opacity: 0.6 } }, ep.mode.toUpperCase())
                ),
                React.createElement(Handle, { type: "source", position: Position.Right, id: ep.id, style: { background: ep.mode === "wire" ? "#a855f7" : "#3b82f6" } })
              )
            ),

            data.connections && data.connections.length > 0 && React.createElement(React.Fragment, null,
              React.createElement("div", { className: "section-title" }, "Internal Connections"),
              data.connections.map((c, i) => 
                React.createElement("div", { key: i, className: "conn-card" },
                  React.createElement("div", { className: "conn-path" }, c.source + " ‚Üí " + c.destinations.join(", ")),
                  (c.transferPdus || []).map((tp, j) => 
                    React.createElement("span", { key: j, className: "pdu-tag" }, tp.pduKeyGroupId)
                  )
                )
              )
            )
          )
        );
      }

      const nodeTypes = { bridgeNode: BridgeNode };

      function App() {
        const [jsonText, setJsonText] = useState(JSON.stringify(SAMPLE_DATA, null, 2));
        const [nodes, setNodes, onNodesChange] = useNodesState([]);
        const [edges, setEdges, onEdgesChange] = useEdgesState([]);
        const [error, setError] = useState(null);

        // „Ç∞„É©„ÉïÊßãÈÄ†„ÅÆÊßãÁØâ
        const buildGraph = (config) => {
          const endpointToNode = new Map();
          const endpointsByNode = new Map();

          (config.endpoints || []).forEach(ne => {
            endpointsByNode.set(ne.nodeId, ne.endpoints || []);
            (ne.endpoints || []).forEach(ep => endpointToNode.set(ep.id, ne.nodeId));
          });

          const connsByNode = new Map();
          (config.connections || []).forEach(c => {
            if (!connsByNode.has(c.nodeId)) connsByNode.set(c.nodeId, []);
            connsByNode.get(c.nodeId).push({
              source: c.source.endpointId,
              destinations: (c.destinations || []).map(d => d.endpointId),
              transferPdus: c.transferPdus || []
            });
          });

          const newNodes = (config.nodes || []).map((n, idx) => ({
            id: n.id,
            type: "bridgeNode",
            position: { x: 80 + idx * 450, y: 100 },
            data: {
              label: n.id,
              endpoints: endpointsByNode.get(n.id) || [],
              connections: connsByNode.get(n.id) || []
            }
          }));

          const newEdges = (config.wireLinks || []).map(link => ({
            id: `edge-${link.from}-${link.to}`,
            source: endpointToNode.get(link.from),
            target: endpointToNode.get(link.to),
            sourceHandle: link.from,
            targetHandle: link.to,
            animated: true,
            style: { stroke: "#a855f7", strokeWidth: 3 },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#a855f7" },
          })).filter(e => e.source && e.target);

          setNodes(newNodes);
          setEdges(newEdges);
        };

        // ÈáçË¶ÅÔºö„ÉÜ„Ç≠„Çπ„Éà„Åæ„Åü„ÅØ„Éï„Ç°„Ç§„É´„Åã„ÇâË®≠ÂÆö„ÇíÂèçÊò†„Åô„Çã„Ç≥„Ç¢Èñ¢Êï∞
        const applyJson = useCallback((text) => {
          setError(null);
          try {
            const parsed = JSON.parse(text);
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            const ajv = new window.ajv7();
            const validate = ajv.compile(BRIDGE_SCHEMA);
            if (!validate(parsed)) {
              setError("Schema Error: " + ajv.errorsText(validate.errors));
              return;
            }

            // „Ç∞„É©„Éï„ÇíÊßãÁØâ
            buildGraph(parsed);
            setJsonText(text); // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÇíÂêåÊúü
          } catch (e) {
            setError("JSON Error: " + e.message);
          }
        }, [setNodes, setEdges]);

        // ÂàùÊúüÂåñ
        useEffect(() => {
          applyJson(jsonText);
        }, []);

        // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ
        const onFileChange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const content = ev.target.result;
            applyJson(content); // Ë™≠„ÅøËæº„Çì„Å†ÂÜÖÂÆπ„ÅßÁõ¥Êé•Êõ¥Êñ∞
          };
          reader.readAsText(file);
          e.target.value = ""; // Âêå„Åò„Éï„Ç°„Ç§„É´„ÇíÂÜçÂ∫¶ÈÅ∏ÊäûÂèØËÉΩ„Å´
        };

        return React.createElement("div", { className: "app" },
          React.createElement("div", { className: "header" },
            React.createElement("div", { style: { fontWeight: 900 } }, "HAKONIWA VISUALIZER v2.1"),
            React.createElement("div", { className: "status-ok" }, error ? "" : "‚úî Graph Synchronized")
          ),

          React.createElement("div", { className: "main" },
            React.createElement("div", { className: "sidebar" },
              React.createElement("div", { style: { display: 'flex', gap: '8px', marginBottom: '12px' } },
                React.createElement("button", { className: "btn primary", style: {flex:1}, onClick: () => applyJson(jsonText) }, "Apply Changes"),
                React.createElement("label", { className: "btn outline" }, "üìÇ Open File", 
                  React.createElement("input", { type: "file", onChange: onFileChange })
                )
              ),

              error && React.createElement("div", { className: "error-box" }, error),

              React.createElement("textarea", {
                value: jsonText,
                onChange: (e) => setJsonText(e.target.value),
                spellCheck: false
              }),

              React.createElement("div", { style: {fontSize: '11px', color: '#64748b'} },
                "‚Äª Â∑¶„Éë„Éç„É´„ÅßJSON„ÇíÁ∑®ÈõÜÂæå„ÄÅ„ÄåApply Changes„Äç„ÇíÊäº„Åô„Å®ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Å†Â†¥Âêà„ÅØÂç≥Â∫ß„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ"
              )
            ),

            React.createElement("div", { className: "canvas" },
              React.createElement(ReactFlow, {
                nodes, edges, onNodesChange, onEdgesChange, nodeTypes, fitView: true
              },
                React.createElement(Background, { gap: 24, color: "#e2e8f0" }),
                React.createElement(Controls),
                React.createElement(MiniMap)
              )
            )
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    });
  </script>
</body>
</html>